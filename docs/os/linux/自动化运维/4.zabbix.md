:::info
zabbix版本：7.4.0&7.4.6

交换机：华为S接入、汇聚的V200R022版本

自动发现规则负责生成列表，监控项原型定义数据采集的细节及采集内容

测试oid命令：snmpget -v 2c -c community 192.168.1.1 .1.3.6.1.4.1.2011.5.25.31.1.1.1.1.5.1
:::
## 准备工作
### 安装`net-snmp-utils`

- Ubuntu/Debian
```
apt-get install snmp snmp-mibs-downloader
```
- CentOS/RHEL
```
yum install net-snmp-utils
```
### 修改配置文件
编辑`/etc/snmp/snmp.conf`，添加以下行让系统加载所有 MIB：
```
mibs +ALL
```
### 重启zabbix服务
```
systemctl restart zabbix-server
```
### 将mib文件上传至服务器
将下载好的mib文件上传至zabbix服务器的`/usr/share/snmp/mibs`目录下

## zabbix操作
### 告警媒介

:::warning
须修改脚本中的主机群组、手机号
:::

#### 参数

| 名称 | 值 |
| :--- | :--- |
| To | {ALERT.SENDTO} |
| Subject | {ALERT.SUBJECT} |
| Message | {ALERT.MESSAGE} |
| Trigger_Groups | {TRIGGER.HOSTGROUP.NAME} |
| HTTPProxy |  |

#### 脚本
```js
try {
    // 1. 解析来自 Zabbix 的参数
    var params = JSON.parse(value);
    var req = new HttpRequest();

    // 2. 获取当前时间并转为 UTC+8（北京时间）
    var date = new Date();
    var utc8Time = new Date(date.getTime() + 8 * 60 * 60 * 1000);
    var timeStr = utc8Time.toISOString().replace('T', ' ').substring(0, 19);

    // 3. 逻辑判断：根据主机群组决定艾特谁
    var groups = params.Trigger_Groups || "";
    var targetMobiles = [];
    var atText = "";

    // 匹配“交换机/办公”或“服务器”群组
    if (groups.indexOf("交换机/办公") !== -1 || groups.indexOf("服务器") !== -1) {
        targetMobiles = ["123456789"];
        // 钉钉要求：content文本中必须包含手机号，@ 才会真正生效并触发强提醒
        atText = "\n通知值班员: @123456789"; 
    }

    // 4. 构造钉钉消息体
    var msg = {
        msgtype: 'text',
        text: {
            content: '[时间] ' + timeStr + '\n' + 
                     '[主题] ' + params.Subject + '\n' + 
                     '[详情] ' + params.Message + atText
        },
        at: {
            atMobiles: targetMobiles,
            isAtAll: false
        }
    };

    // 5. 设置 HTTP 代理（如有）
    if (params.HTTPProxy && params.HTTPProxy !== '') {
        req.setProxy(params.HTTPProxy);
    }

    // 6. 添加请求头
    req.addHeader('Content-Type: application/json');

    // 7. 发送 POST 请求到钉钉 Webhook 地址 (To)
    var resp = req.post(params.To, JSON.stringify(msg));

    // 8. 响应校验
    if (req.getStatus() != 200) {
        throw 'HTTP 状态码异常: ' + req.getStatus() + ', 响应内容: ' + resp;
    }

    return '发送成功';

} catch (error) {
    throw '告警脚本执行失败: ' + error;
}
```
